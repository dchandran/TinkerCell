/****************************************************************************

 Copyright (c) 2008 Deepak Chandran
 Contact: Deepak Chandran (dchandran1@gmail.com)
 see COPYRIGHT.TXT

 Function that loads dll into main window

****************************************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <QFile>
#include <QRegExp>
#include <QMessageBox>
#include "MainWindow.h"
#include "DynamicCodeMain.h"

extern "C" TINKERCELLEXPORT void loadTCTool(Tinkercell::MainWindow * main)
{
	if (!main) return;
	QString appDir = QCoreApplication::applicationDirPath();
	QString homeDir = Tinkercell::MainWindow::homeDir();
	QString tempDir = Tinkercell::MainWindow::tempDir();

#ifdef Q_WS_WIN

	tempDir.replace(QObject::tr("/"),QObject::tr("\\"));
	appDir.replace(QObject::tr("/"),QObject::tr("\\"));
	homeDir = QObject::tr("\"") + homeDir.replace(QObject::tr("/"),QObject::tr("\\")) + QObject::tr("\"");

	QString s1(QObject::tr("copy \"") + appDir + QObject::tr("\"\\win32\\*.* \"") + tempDir + QObject::tr("\" /Y"));
	if (system(s1.toAscii().data()) < 0)
		QMessageBox::information(Tinkercell::MainWindow::instance(), "Error", "Unable to copy some needed GCC files to temporary folder");

#endif

    Tinkercell::DynamicLibraryMenu * libMenu = new Tinkercell::DynamicLibraryMenu;
    Tinkercell::LoadCLibrariesTool * cLibraries = new Tinkercell::LoadCLibrariesTool;
    Tinkercell::PythonTool * pythonTool = new Tinkercell::PythonTool;
    Tinkercell::OctaveTool * octaveTool = new Tinkercell::OctaveTool;
    Tinkercell::CodingWindow * cScriptWindow = new Tinkercell::CodingWindow;

	if (Tinkercell::CodingWindow::DO_SVN_UPDATE)
	{
		QString s;
		int err = 0;
		if (!QFile::exists(homeDir + QObject::tr("/.svn")))
		{
			s = QObject::tr("svn co https://tinkercellextra.svn.sourceforge.net/svnroot/tinkercellextra ") + homeDir;
			err =system(s.toAscii().data());
		}

		s = QObject::tr("cd ") + homeDir + QObject::tr("; svn update");
		if (err < 0 || system(s.toAscii().data()) < 0)
				QMessageBox::information(Tinkercell::MainWindow::instance(), "Error", "Unable to call SVN for auto-update. Check that SVN is installed and located in the system path.");
		
		QFile file;
		file.setFileName( Tinkercell::MainWindow::homeDir() + QObject::tr("/updates.txt") );
		if (file.open( QFile::ReadOnly | QFile::Text ))
		{
			QString text(file.readAll());
			QRegExp regex("current version:\\s*([\\.0-9]+)");
			if (regex.indexIn(text) > -1)
			{
				QString v = regex.cap(1);
				if (v != QObject::tr("@TINKERCELL_WC_REVISION@"))	
					//QMessageBox::about(Tinkercell::MainWindow::instance(), "New version", "A new version of TinkerCell is available for download  at <a href='http://www.tinkercell.com/downloads-2'>tinkercell.com</a>");
					main->statusBar()->showMessage(QString("A new version of TinkerCell is available for download  at <a href='http://www.tinkercell.com/downloads-2'>tinkercell.com</a>"));
			}
			file.close();
		}
	}

	main->addTool(libMenu);
    main->addTool(cLibraries);
	main->addTool(pythonTool);
	main->addTool(octaveTool);
	main->addTool(cScriptWindow);
}

