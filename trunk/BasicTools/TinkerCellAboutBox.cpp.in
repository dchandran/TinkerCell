#include "ConsoleWindow.h"
#include "TinkerCellAboutBox.h"
#include <QPixmap>
#include <QBrush>
#include <QTextEdit>
#include <QDesktopServices>

namespace Tinkercell
{
	TinkercellAboutBox::TinkercellAboutBox() : Tool(tr("TinkerCell About Box"),tr("Basic GUI"))
	{
		QHBoxLayout * layout1 = new QHBoxLayout;

		
		MainWindow::PROJECT_VERSION = tr("@TINKERCELL_WC_REVISION@");		
		QString text;
		
		bool ok;
		int number = MainWindow::PROJECT_VERSION.toInt(&ok);
		if (ok)
		{
			MainWindow::PROJECT_VERSION = tr("1.") + QString::number( (int)(number/1000 ) ) + tr(".") + QString::number(number % 1000);
		}

		text = tr("TinkerCell\nVersion: ") + MainWindow::PROJECT_VERSION;
		QString appDir = QCoreApplication::applicationDirPath();
		QString filename = appDir + tr("/about.txt");

		QFile file;
		file.setFileName( filename );
		bool opened = ( file.open( QFile::ReadOnly | QFile::Text ) );

		if (!opened)
		{
		}
		else
		{
			QString allText(file.readAll());
			text += allText + tr("\n");
			file.close();
		}
		QTextEdit * edit = new QTextEdit(this);
		edit->setPlainText(text);
		edit->setReadOnly(true);

		QPalette palette;
		palette.setBrush(edit->backgroundRole(), QBrush(QPixmap(":/images/Tinkercell.png").scaled(256,256)));
		edit->setPalette(palette);
		layout1->addWidget(edit);


		dialog.setLayout(layout1);

	}

	bool TinkercellAboutBox::setMainWindow(MainWindow * main)
	{
		Tool::setMainWindow(main);
		if (mainWindow)
		{
			if (mainWindow->helpMenu)
			{
				//mainWindow->helpMenu->addAction(QIcon(":/images/question.png"),tr("User's Guide"),this,SLOT(openDocumentation()));
				mainWindow->helpMenu->addAction(QIcon(":/images/globe.png"),tr("TinkerCell Homepage"),this,SLOT(openHomePage()));
				mainWindow->helpMenu->addAction(QIcon(":/images/globe.png"),tr("TinkerCell Blog"),this,SLOT(openBlog()));
				mainWindow->helpMenu->addAction(tr("Write to us"),this,SLOT(emailAuthor()));
				mainWindow->helpMenu->addSeparator();
				mainWindow->helpMenu->addAction(QIcon(":/images/about.png"),tr("About"),this,SLOT(showAboutBox()));
			}
			return true;
		}
		return false;
	}

	void TinkercellAboutBox::showAboutBox()
	{
		dialog.show();
	}

	void TinkercellAboutBox::openDocumentation()
	{

		QString appDir = QCoreApplication::applicationDirPath();

		//QString doc( "@TINKERCELL_SOURCE_DIR@/Documentation/UserDocumentation.html" );
		QString doc = tr("file:") + appDir + tr("/Documentation/UserDocumentation.html");
		QDesktopServices::openUrl(QUrl(doc));
	}

	void TinkercellAboutBox::openBlog()
	{
		QDesktopServices::openUrl(QUrl("http://tinker-cell.blogspot.com/"));
	}

	void TinkercellAboutBox::openHomePage()
	{
		QDesktopServices::openUrl(QUrl("http://www.tinkercell.com/"));
	}

	void TinkercellAboutBox::emailAuthor()
	{
		QDesktopServices::openUrl(QUrl("mailto:admin@tinkercell.com?subject=TinkerCell Report"));
	}
}

